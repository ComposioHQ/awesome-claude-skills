#!/bin/bash
# =============================================================================
# PRE-COMMIT HOOK - FENRIR Static Analysis
# =============================================================================
# Phase 301.5: Blocks commits with MORTEL findings
#
# Installation:
#   cp scripts/pre-commit-fenrir .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or with symlink (recommended - stays updated):
#   ln -sf ../../apps/backend/scripts/pre-commit-fenrir .git/hooks/pre-commit
#
# Exit codes:
#   0 = Clean or only SUSPECT findings
#   1 = GRAVE findings (warning, allows commit)
#   2 = MORTEL findings (blocks commit)
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Get staged Python files
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_PY_FILES" ]; then
    echo -e "${GREEN}No Python files staged, skipping FENRIR${NC}"
    exit 0
fi

# Count files
FILE_COUNT=$(echo "$STAGED_PY_FILES" | wc -l)
echo -e "${YELLOW}FENRIR scanning $FILE_COUNT Python file(s)...${NC}"

# Find FENRIR script (handle different working directories)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
if [ -f "$SCRIPT_DIR/fenrir.py" ]; then
    FENRIR="$SCRIPT_DIR/fenrir.py"
elif [ -f "apps/backend/scripts/fenrir.py" ]; then
    FENRIR="apps/backend/scripts/fenrir.py"
elif [ -f "scripts/fenrir.py" ]; then
    FENRIR="scripts/fenrir.py"
else
    echo -e "${RED}ERROR: fenrir.py not found${NC}"
    exit 0  # Don't block if FENRIR missing
fi

# Run FENRIR on each staged file
MORTEL_COUNT=0
GRAVE_COUNT=0
SUSPECT_COUNT=0

for FILE in $STAGED_PY_FILES; do
    if [ -f "$FILE" ]; then
        # Run FENRIR quietly
        OUTPUT=$(python "$FENRIR" "$FILE" --quiet 2>/dev/null || true)

        if [ -n "$OUTPUT" ]; then
            # Parse counts from output: "FENRIR: X total | Y MORTEL | Z GRAVE | W SUSPECT"
            if echo "$OUTPUT" | grep -q "MORTEL"; then
                M=$(echo "$OUTPUT" | grep -oP '\d+(?= MORTEL)' || echo 0)
                MORTEL_COUNT=$((MORTEL_COUNT + M))
            fi
            if echo "$OUTPUT" | grep -q "GRAVE"; then
                G=$(echo "$OUTPUT" | grep -oP '\d+(?= GRAVE)' || echo 0)
                GRAVE_COUNT=$((GRAVE_COUNT + G))
            fi
            if echo "$OUTPUT" | grep -q "SUSPECT"; then
                S=$(echo "$OUTPUT" | grep -oP '\d+(?= SUSPECT)' || echo 0)
                SUSPECT_COUNT=$((SUSPECT_COUNT + S))
            fi
        fi
    fi
done

# Report results
echo ""
if [ $MORTEL_COUNT -gt 0 ]; then
    echo -e "${RED}BLOCKED: $MORTEL_COUNT MORTEL finding(s) detected${NC}"
    echo ""
    echo "Run 'python scripts/fenrir.py <file> --fix' to see suggestions"
    echo "Or 'git commit --no-verify' to bypass (not recommended)"
    exit 2
fi

if [ $GRAVE_COUNT -gt 0 ]; then
    echo -e "${YELLOW}WARNING: $GRAVE_COUNT GRAVE finding(s) detected${NC}"
    echo "Consider fixing before pushing. Commit allowed."
fi

if [ $SUSPECT_COUNT -gt 0 ]; then
    echo -e "${NC}INFO: $SUSPECT_COUNT SUSPECT pattern(s) detected${NC}"
fi

if [ $MORTEL_COUNT -eq 0 ] && [ $GRAVE_COUNT -eq 0 ] && [ $SUSPECT_COUNT -eq 0 ]; then
    echo -e "${GREEN}FENRIR: All clear${NC}"
fi

exit 0
